---
- hosts: hartweb.cloud.hartcode.com
  remote_user: hartalex
  vars:
   local_deploy_version: "{{ lookup('env','DEPLOY_VERSION') }}"
   port: "{{ lookup('env','PORT') }}"
   commit: "{{ lookup('env', 'CI_BUILD_REF') }}"
  tasks:
    - name: get latest container
      become: true
      command: "gcloud docker pull gcr.io/hartonline-cloud/hartcode.com:{{local_deploy_version}}"
    - name: restart hartcode.com
      become: true
      docker_container:
        name: "{{port}}.hartcode.com"
        image: "gcr.io/hartonline-cloud/hartcode.com:{{local_deploy_version}}"
        state: started
        restart: yes
        recreate: yes
        restart_policy: always
        ports:
          "{{port}}:8811"
        env:
          NODE_ENV: production
    - wait_for: delay=10      
    - name: Get JSON from page
      uri: url="localhost:{{port}}/info" return_content=yes
      register: json_response
    - name: Validate commit
      fail: msg="The commits don't match"
      when:  "(json_response.content|from_json)['commit'] is defined and (json_response.content|from_json)['commit'] == {{commit}}"
